<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Scanner QR SUNAT</title>
  <style>
    body{font-family:Arial;background:#0f172a;color:#fff;text-align:center;padding:18px}
    #reader{width:100%;max-width:360px;margin:12px auto}
    button{padding:10px 14px;border-radius:10px;border:0;margin:6px;cursor:pointer}
    .b1{background:#22c55e;color:#052e16;font-weight:700}
    .b2{background:transparent;border:1px solid #334155;color:#fff}
    #msg{margin:10px auto;max-width:520px;background:#111827;border:1px solid #334155;border-radius:12px;padding:10px;text-align:left}
    table{margin-top:14px;width:100%;border-collapse:collapse}
    th,td{border:1px solid #334155;padding:8px;font-size:14px}
    th{background:#1e293b}
    a{color:#93c5fd;word-break:break-all}
  </style>
</head>
<body>

<h2>Escanear QR - Guía SUNAT</h2>

<div id="msg">Estado: <b id="status">Cargando librería…</b><br>
  <span id="detail" style="color:#a7b2c7"></span>
</div>

<div id="reader"></div>

<button class="b1" id="btnStart" disabled>Iniciar cámara</button>
<button class="b2" id="btnStop" disabled>Detener</button>

<table>
  <tr><th>Campo</th><th>Valor</th></tr>
  <tr><td>FECHA</td><td id="fecha"></td></tr>
  <tr><td>SERIE</td><td id="serie"></td></tr>
  <tr><td>NÚMERO</td><td id="numero"></td></tr>
  <tr><td>RUC</td><td id="ruc"></td></tr>
  <tr><td>URL</td><td id="url"></td></tr>
</table>

<script>
  // 1) Carga dinámica con fallback (unpkg -> jsdelivr)
  function loadScript(src){
    return new Promise((resolve, reject)=>{
      const s=document.createElement("script");
      s.src=src;
      s.onload=resolve;
      s.onerror=reject;
      document.head.appendChild(s);
    });
  }

  const $=(id)=>document.getElementById(id);
  function setMsg(s,d=""){ $("status").textContent=s; $("detail").textContent=d; }

  async function ensureHtml5Qrcode(){
    try{
      await loadScript("https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js");
      return true;
    }catch(_){
      try{
        await loadScript("https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/html5-qrcode.min.js");
        return true;
      }catch(e){
        return false;
      }
    }
  }

  let qr=null, running=false;

  async function init(){
    const ok = await ensureHtml5Qrcode();
    if(!ok || typeof Html5Qrcode === "undefined"){
      setMsg("No se pudo cargar html5-qrcode",
        "Tu red/bloqueador está impidiendo descargar la librería (unpkg/jsdelivr). Prueba con datos móviles o sin VPN.");
      return;
    }
    setMsg("Listo ✅", "Presiona “Iniciar cámara”.");
    $("btnStart").disabled=false;
  }

  $("btnStart").onclick = async () => {
    try{
      if(!window.isSecureContext){
        alert("Debe ser HTTPS (ya lo estás usando).");
        return;
      }

      // pide permiso (mejora compatibilidad)
      await navigator.mediaDevices.getUserMedia({video:true,audio:false});

      if(!qr) qr = new Html5Qrcode("reader");

      const cams = await Html5Qrcode.getCameras();
      if(!cams || !cams.length) throw new Error("No se detectaron cámaras");

      const back = cams.find(c => /back|rear|environment/i.test(c.label));
      const camId = (back || cams[cams.length-1]).id;

      $("btnStart").disabled=true;
      $("btnStop").disabled=false;

      running=true;
      setMsg("Cámara activa ✅","Apunta al QR.");

      await qr.start(
        { deviceId: { exact: camId } },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          $("url").innerHTML = `<a href="${decodedText}" target="_blank" rel="noopener">${decodedText}</a>`;

          const parts = decodedText.split("|");
          if(parts.length >= 5){
            $("ruc").textContent = parts[0] || "";
            $("serie").textContent = parts[2] || "";
            $("numero").textContent = parts[3] || "";
            $("fecha").textContent = parts[4] || "";
          }
          setMsg("QR leído ✅","Listo.");
        }
      );
    }catch(e){
      console.error(e);
      const name = e?.name || "";
      let det = e?.message || "";
      if(name==="NotAllowedError") det="Permiso de cámara DENEGADO. Actívalo en permisos del sitio.";
      setMsg("No se pudo abrir la cámara.", det);
      $("btnStart").disabled=false;
      $("btnStop").disabled=true;
      running=false;
    }
  };

  $("btnStop").onclick = async () => {
    try{
      if(qr && running){
        await qr.stop();
        await qr.clear();
      }
    }catch(_){}
    running=false;
    $("btnStart").disabled=false;
    $("btnStop").disabled=true;
    setMsg("Detenido","Puedes iniciar nuevamente.");
  };

  init();
</script>

</body>
</html>
