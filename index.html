<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Extractor de Gu√≠as (SUNAT / F√≠sicas) ‚Äî 100% Web</title>

  <!-- Librer√≠as (CDN) -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.5/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#0f1a33; --card2:#0c162d;
      --text:#e8eefc; --muted:#a8b3d6; --line:#23365f;
      --accent:#5eead4; --accent2:#60a5fa; --danger:#fb7185;
      --ok:#34d399; --warn:#fbbf24;
      --shadow: 0 10px 35px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.22), transparent 60%),
                  radial-gradient(1200px 600px at 90% 0%, rgba(94,234,212,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:var(--sans);
    }
    header{
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.7);
      border-bottom: 1px solid rgba(35,54,95,.7);
      z-index: 10;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px}
    .title{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    h1{margin:0;font-size:18px;display:flex;gap:10px;align-items:center;}
    .badge{
      font-size:12px;padding:4px 10px;border:1px solid rgba(94,234,212,.45);
      color:var(--accent);border-radius:999px;background: rgba(94,234,212,.08);
    }
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35;}
    .grid{display:grid;grid-template-columns: 1.05fr .95fr;gap:14px;margin-top:14px;}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 40%), var(--card);
      border: 1px solid rgba(35,54,95,.8); border-radius: var(--radius);
      box-shadow: var(--shadow); overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px 14px; border-bottom: 1px solid rgba(35,54,95,.8);
      background: rgba(255,255,255,.02);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .card .hd strong{font-size:14px}
    .card .bd{padding:14px}

    .tabs{display:flex; gap:10px; flex-wrap:wrap;}
    .tabbtn{
      cursor:pointer; user-select:none;
      border: 1px solid rgba(35,54,95,.9);
      background: rgba(12,22,45,.85);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      font-size: 13px;
      display:flex; align-items:center; gap:10px;
      transition:.15s ease;
    }
    .tabbtn.active{
      border-color: rgba(94,234,212,.55);
      background: rgba(94,234,212,.10);
      color: var(--accent);
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      cursor:pointer;
      border:1px solid rgba(35,54,95,.9);
      background: rgba(12,22,45,.75);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      font-size: 13px;
      transition:.15s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(96,165,250,.6)}
    .btn.primary{border-color: rgba(94,234,212,.55); background: rgba(94,234,212,.12); color: var(--accent);}
    .btn.blue{border-color: rgba(96,165,250,.55); background: rgba(96,165,250,.12); color: var(--accent2);}
    .btn.danger{border-color: rgba(251,113,133,.6); background: rgba(251,113,133,.12); color: var(--danger);}
    .btn.ok{border-color: rgba(52,211,153,.55); background: rgba(52,211,153,.12); color: var(--ok);}

    input[type="file"]{
      width:100%; padding:12px;
      border-radius: 12px;
      border:1px dashed rgba(35,54,95,.95);
      background: rgba(12,22,45,.55);
      color: var(--muted);
    }
    .hint{margin-top:8px;color: var(--muted);font-size:12px;line-height:1.35;}
    .mono{
      font-family: var(--mono); font-size: 12px;
      color: rgba(232,238,252,.9);
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(35,54,95,.7);
      border-radius: 12px;
      padding:10px;
      overflow:auto;
      max-height: 220px;
      white-space: pre-wrap;
    }
    .sep{height:1px;background:rgba(35,54,95,.7);margin:14px 0}
    .small{font-size:12px;color:var(--muted)}

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(35,54,95,.8);
      background: rgba(12,22,45,.55);
    }
    th, td{padding:10px 10px;border-bottom: 1px solid rgba(35,54,95,.6);vertical-align: top;}
    th{text-align:left;font-size: 12px;color: rgba(232,238,252,.9);background: rgba(255,255,255,.03);position: sticky;top: 0;z-index: 2;}
    td input{
      width:100%; padding:9px 10px;border-radius: 10px;
      border:1px solid rgba(35,54,95,.8);
      background: rgba(0,0,0,.16);
      color: var(--text);
      font-size: 13px;
      outline:none;
    }
    td input:focus{border-color: rgba(94,234,212,.5);box-shadow: 0 0 0 3px rgba(94,234,212,.12);}

    #qr-reader{
      width:100%;
      max-width: 520px;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(35,54,95,.8);
      background: rgba(0,0,0,.10);
    }
    .qrrow{display:flex; gap:14px; flex-wrap:wrap; align-items:flex-start;}

    .imgbox{
      border:1px solid rgba(35,54,95,.8);
      background: rgba(0,0,0,.10);
      border-radius: 14px;
      padding:10px;
      overflow:hidden;
    }
    .imgbox canvas{width:100%;height:auto;border-radius: 10px;display:block;background: #0a0f1c;}

    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.55);
      z-index:999;
      padding: 20px;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(520px, 100%);
      border-radius: 16px;
      border:1px solid rgba(35,54,95,.9);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(12,22,45,.92));
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .spin{
      width: 18px; height: 18px;
      border-radius: 999px;
      border: 3px solid rgba(96,165,250,.20);
      border-top-color: rgba(94,234,212,.85);
      animation: rot 1s linear infinite;
      display:inline-block;
      vertical-align:middle;
      margin-right: 10px;
    }
    @keyframes rot{to{transform:rotate(360deg)}}
    .prog{
      margin-top:10px;
      width:100%;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(35,54,95,.7);
      overflow:hidden;
    }
    .prog > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(96,165,250,.7), rgba(94,234,212,.7));
      transition: width .12s ease;
    }

    /* Diagn√≥stico */
    .diag{
      border:1px solid rgba(35,54,95,.8);
      background: rgba(12,22,45,.55);
      border-radius: 14px;
      padding: 10px;
      line-height: 1.35;
      font-size: 12px;
      color: rgba(232,238,252,.9);
    }
    .pill{
      display:inline-flex; gap:6px; align-items:center;
      padding:3px 8px; border-radius:999px;
      border:1px solid rgba(35,54,95,.8);
      background: rgba(0,0,0,.16);
      margin: 3px 6px 0 0;
      font-size: 12px;
    }
    .pill.ok{border-color: rgba(52,211,153,.55); color: var(--ok); background: rgba(52,211,153,.10);}
    .pill.bad{border-color: rgba(251,113,133,.55); color: var(--danger); background: rgba(251,113,133,.10);}
    .pill.warn{border-color: rgba(251,191,36,.55); color: var(--warn); background: rgba(251,191,36,.10);}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="title">
      <h1>Extractor de Gu√≠as (SUNAT / F√≠sicas) <span class="badge">100% Web</span></h1>
      <div class="row">
        <button class="btn blue" id="btnDownloadCsv">‚¨áÔ∏è Descargar CSV</button>
        <button class="btn danger" id="btnClearAll">üßπ Limpiar tabla</button>
      </div>
    </div>
    <div class="sub">
      <b>Electr√≥nica:</b> QR ‚Üí abrir link ‚Üí descargar PDF ‚Üí subir PDF aqu√≠.<br/>
      <b>F√≠sica:</b> foto/escaneo ‚Üí OCR ‚Üí extraer ‚Üí corregir ‚Üí guardar.
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- IZQUIERDA -->
    <section class="card">
      <div class="hd">
        <strong>Opciones</strong>
        <div class="tabs">
          <div class="tabbtn active" id="tabElec">üßæ Gu√≠a electr√≥nica (QR / PDF)</div>
          <div class="tabbtn" id="tabFis">üì∑ Gu√≠a f√≠sica (foto / escaneo)</div>
        </div>
      </div>

      <!-- DIAGN√ìSTICO -->
      <div class="bd">
        <strong style="font-size:13px;">Diagn√≥stico (si ‚Äúno hace nada‚Äù, mira esto)</strong>
        <div class="hint">Debe decir OK en librer√≠as. Para QR/c√°mara: HTTPS o localhost.</div>
        <div class="diag" id="diagBox">(cargando diagn√≥stico‚Ä¶)</div>
      </div>

      <!-- ELECTR√ìNICA -->
      <div class="bd" id="panelElec" style="padding-top:0;">
        <div class="sep"></div>

        <div class="qrrow">
          <div style="flex:1 1 520px;">
            <div class="row" style="justify-content:space-between;margin-bottom:10px;">
              <div class="small">Escaneo QR (requiere HTTPS o localhost)</div>
              <div class="row">
                <button class="btn primary" id="btnStartQr">‚ñ∂Ô∏è Iniciar QR</button>
                <button class="btn" id="btnStopQr">‚èπÔ∏è Detener</button>
              </div>
            </div>
            <div id="qr-reader"></div>
            <div class="hint" id="qrHint">
              Si sale error de c√°mara: publ√≠calo en <b>HTTPS</b> (GitHub Pages) o usa <b>localhost</b>.
            </div>
          </div>

          <div style="flex:1 1 300px;">
            <div class="small">Resultado del QR</div>
            <div class="mono" id="qrResult">(A√∫n no escaneado)</div>
            <div class="row" style="margin-top:10px;">
              <button class="btn blue" id="btnOpenQr" disabled>üîó Abrir link</button>
              <button class="btn" id="btnCopyQr" disabled>üìã Copiar</button>
            </div>
            <div class="hint">
              El navegador normalmente no puede ‚Äúdescargar el PDF de SUNAT solo‚Äù. Abre el link, descarga el PDF y s√∫belo abajo.
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <strong style="font-size:13px;">Subir PDF (Gu√≠a electr√≥nica descargada)</strong>
        <div class="hint">Si el PDF es ‚Äúreal‚Äù, se extrae por texto. Si es escaneado, usa OCR (gu√≠a f√≠sica).</div>
        <input type="file" id="filePdfElec" accept="application/pdf" />

        <div class="sep"></div>
        <strong style="font-size:13px;">Vista previa (editable)</strong>
        <div class="hint">Revisa/corrige los 4 campos y agrega a la tabla.</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn ok" id="btnAddPreviewElec" disabled>‚ûï Agregar a tabla</button>
          <button class="btn" id="btnResetPreviewElec" disabled>‚Ü©Ô∏è Reset</button>
        </div>

        <div style="margin-top:12px;">
          <div class="small">Raz√≥n social</div>
          <input id="prevElecRS" placeholder="(extra√≠do o escribe)" style="width:100%;margin-top:6px;padding:10px;border-radius:12px;border:1px solid rgba(35,54,95,.8);background:rgba(0,0,0,.16);color:var(--text);" />
          <div class="row" style="margin-top:10px;">
            <div style="flex:1;">
              <div class="small">Fecha</div>
              <input id="prevElecFecha" placeholder="dd/mm/aaaa" style="width:100%;margin-top:6px;padding:10px;border-radius:12px;border:1px solid rgba(35,54,95,.8);background:rgba(0,0,0,.16);color:var(--text);" />
            </div>
            <div style="flex:1;">
              <div class="small">Cantidad</div>
              <input id="prevElecCant" placeholder="Ej: 135" style="width:100%;margin-top:6px;padding:10px;border-radius:12px;border:1px solid rgba(35,54,95,.8);background:rgba(0,0,0,.16);color:var(--text);" />
            </div>
          </div>
          <div class="small" style="margin-top:10px;">Descripci√≥n</div>
          <input id="prevElecDesc" placeholder="Descripci√≥n del bien" style="width:100%;margin-top:6px;padding:10px;border-radius:12px;border:1px solid rgba(35,54,95,.8);background:rgba(0,0,0,.16);color:var(--text);" />
          <div class="hint" id="prevElecMeta" style="margin-top:10px;"></div>
        </div>

        <div class="sep"></div>
        <details>
          <summary class="small" style="cursor:pointer;">Ver texto extra√≠do (debug)</summary>
          <div class="mono" id="debugElec"></div>
        </details>
      </div>

      <!-- F√çSICA -->
      <div class="bd" id="panelFis" style="display:none; padding-top:0;">
        <div class="sep"></div>

        <strong style="font-size:13px;">Subir foto / escaneo (imagen o PDF escaneado)</strong>
        <div class="hint">En celular: usa ‚ÄúTomar foto‚Äù. Recomendado: buena luz, enfoque y contraste.</div>

        <input type="file" id="fileFis" accept="image/*,application/pdf" capture="environment" />

        <div class="row" style="margin-top:12px;">
          <button class="btn" id="btnRotateL" disabled>‚ü≤ Rotar</button>
          <button class="btn" id="btnRotateR" disabled>‚ü≥ Rotar</button>
          <button class="btn primary" id="btnRunOcr" disabled>üß† OCR & Extraer</button>
        </div>

        <div class="sep"></div>

        <div class="imgbox">
          <canvas id="imgCanvas" width="900" height="600"></canvas>
          <div class="hint">Si sale de costado, rota antes de OCR.</div>
        </div>

        <div class="sep"></div>

        <strong style="font-size:13px;">Vista previa (editable)</strong>
        <div class="hint">OCR puede fallar con letra a mano. Corrige y agrega.</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn ok" id="btnAddPreviewFis" disabled>‚ûï Agregar a tabla</button>
          <button class="btn" id="btnResetPreviewFis" disabled>‚Ü©Ô∏è Reset</button>
        </div>

        <div style="margin-top:12px;">
          <div class="small">Raz√≥n social</div>
          <input id="prevFisRS" placeholder="(extra√≠do o escribe)" style="width:100%;margin-top:6px;padding:10px;border-radius:12px;border:1px solid rgba(35,54,95,.8);background:rgba(0,0,0,.16);color:var(--text);" />
          <div class="row" style="margin-top:10px;">
            <div style="flex:1;">
              <div class="small">Fecha</div>
              <input id="prevFisFecha" placeholder="dd/mm/aaaa" style="width:100%;margin-top:6px;padding:10px;border-radius:12px;border:1px solid rgba(35,54,95,.8);background:rgba(0,0,0,.16);color:var(--text);" />
            </div>
            <div style="flex:1;">
              <div class="small">Cantidad</div>
              <input id="prevFisCant" placeholder="Ej: 45" style="width:100%;margin-top:6px;padding:10px;border-radius:12px;border:1px solid rgba(35,54,95,.8);background:rgba(0,0,0,.16);color:var(--text);" />
            </div>
          </div>
          <div class="small" style="margin-top:10px;">Descripci√≥n</div>
          <input id="prevFisDesc" placeholder="Descripci√≥n" style="width:100%;margin-top:6px;padding:10px;border-radius:12px;border:1px solid rgba(35,54,95,.8);background:rgba(0,0,0,.16);color:var(--text);" />
          <div class="hint" id="prevFisMeta" style="margin-top:10px;"></div>
        </div>

        <div class="sep"></div>
        <details>
          <summary class="small" style="cursor:pointer;">Ver texto OCR (debug)</summary>
          <div class="mono" id="debugFis"></div>
        </details>
      </div>
    </section>

    <!-- DERECHA -->
    <section class="card">
      <div class="hd">
        <strong>Resultados</strong>
        <div class="small" id="countRows">0 registros</div>
      </div>
      <div class="bd">
        <div class="hint" style="margin-bottom:10px;">
          Puedes editar directo en la tabla y descargar CSV.
        </div>
        <div style="max-height:520px; overflow:auto; border-radius:14px;">
          <table>
            <thead>
              <tr>
                <th style="min-width:190px;">RAZ√ìN SOCIAL</th>
                <th style="min-width:120px;">FECHA</th>
                <th style="min-width:110px;">CANTIDAD</th>
                <th style="min-width:260px;">DESCRIPCI√ìN</th>
                <th style="min-width:120px;">ORIGEN</th>
                <th style="min-width:90px;">ACCIONES</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="sep"></div>
        <div class="small">Privacidad: todo se procesa en tu navegador (no se sube a servidor).</div>
      </div>
    </section>
  </div>
</div>

<!-- Overlay -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div style="display:flex;align-items:center;gap:10px;">
      <span class="spin"></span>
      <div>
        <div style="font-weight:700" id="ovTitle">Procesando‚Ä¶</div>
        <div class="small" id="ovMsg">Un momento</div>
      </div>
    </div>
    <div class="prog"><div id="ovBar"></div></div>
    <div class="small" id="ovPct" style="margin-top:8px;">0%</div>
  </div>
</div>

<script>
  // PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.worker.min.js";

  const $ = (id) => document.getElementById(id);
  const state = { rows: [], qr: { scanner:null, lastText:"" }, fis:{ file:null, rotation:0, canvasReady:false }, previewElec:null, previewFis:null };

  // Overlay
  function setOverlay(show, title="Procesando‚Ä¶", msg="Un momento", pct=0){
    const ov = $("overlay");
    if(!show){ ov.classList.remove("show"); return; }
    $("ovTitle").textContent = title;
    $("ovMsg").textContent = msg;
    $("ovBar").style.width = Math.max(0, Math.min(100, pct)) + "%";
    $("ovPct").textContent = Math.round(pct) + "%";
    ov.classList.add("show");
  }
  function setOverlayPct(pct, msg=null){
    $("ovBar").style.width = Math.max(0, Math.min(100, pct)) + "%";
    $("ovPct").textContent = Math.round(pct) + "%";
    if(msg!==null) $("ovMsg").textContent = msg;
  }

  // Helpers
  const safeText = (s)=> (s ?? "").toString().trim();
  function normalizeText(t){
    return safeText(t)
      .replace(/\u00A0/g," ")
      .replace(/[ \t]+/g," ")
      .replace(/\r/g,"")
      .replace(/\n{3,}/g,"\n\n")
      .trim();
  }
  function fmtDateLike(d){
    const s = safeText(d);
    const m = s.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{2,4})/);
    if(!m) return s;
    let yy = m[3];
    if(yy.length===2) yy = "20"+yy;
    return `${m[1]}/${m[2]}/${yy}`;
  }

  // Tabs
  function activateTab(which){
    const elec = (which==="elec");
    $("tabElec").classList.toggle("active", elec);
    $("tabFis").classList.toggle("active", !elec);
    $("panelElec").style.display = elec ? "" : "none";
    $("panelFis").style.display = elec ? "none" : "";
  }
  $("tabElec").addEventListener("click", ()=>activateTab("elec"));
  $("tabFis").addEventListener("click", ()=>activateTab("fis"));

  // Diagn√≥stico
  function pill(label, ok, kind=null){
    const cls = ok ? "ok" : (kind || "bad");
    return `<span class="pill ${cls}">${ok ? "‚úÖ" : (cls==="warn" ? "‚ö†Ô∏è" : "‚ùå")} ${label}</span>`;
  }
  function updateDiag(){
    const isSecure = (location.protocol==="https:" || location.hostname==="localhost" || location.hostname==="127.0.0.1");
    const hasCam = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
    const libs = {
      "Html5Qrcode": !!window.Html5Qrcode,
      "pdfjsLib": !!window.pdfjsLib,
      "Tesseract": !!window.Tesseract
    };

    let html = "";
    html += `<div><b>Origen:</b> <span class="pill ${isSecure?"ok":"warn"}">${isSecure?"‚úÖ":"‚ö†Ô∏è"} ${location.protocol}//${location.host || "(file://)"}</span></div>`;
    html += `<div style="margin-top:6px;"><b>Librer√≠as:</b><br/>`;
    html += pill("QR lib", libs.Html5Qrcode);
    html += pill("PDF lib", libs.pdfjsLib);
    html += pill("OCR lib", libs.Tesseract);
    html += `</div>`;
    html += `<div style="margin-top:6px;"><b>C√°mara:</b><br/>`;
    html += pill("getUserMedia", hasCam, hasCam ? null : "warn");
    html += pill("HTTPS/localhost requerido para QR", isSecure, isSecure ? null : "warn");
    html += `</div>`;
    html += `<div class="hint" style="margin-top:8px;">Si ves ‚ö†Ô∏è o ‚ùå, ejecuta desde <b>http://localhost</b> (con servidor) o publica en <b>HTTPS</b> (GitHub Pages).</div>`;

    $("diagBox").innerHTML = html;

    if(!isSecure){
      $("qrHint").innerHTML = `‚ö†Ô∏è Est√°s en <b>file://</b> u origen no seguro. Para c√°mara/QR usa <b>localhost</b> o <b>HTTPS</b>.`;
    }
  }

  window.addEventListener("load", updateDiag);

  // Tabla
  function renderTable(){
    const tb = $("tbody");
    tb.innerHTML = "";
    state.rows.forEach((r, idx)=>{
      const tr = document.createElement("tr");

      const mk = (val, oninp)=>{
        const td = document.createElement("td");
        const inp = document.createElement("input");
        inp.value = val;
        inp.addEventListener("input", ()=>oninp(inp.value));
        td.appendChild(inp);
        return td;
      };

      tr.appendChild(mk(r.razon_social, v=>r.razon_social=v));
      tr.appendChild(mk(r.fecha, v=>r.fecha=v));
      tr.appendChild(mk(r.cantidad, v=>r.cantidad=v));
      tr.appendChild(mk(r.descripcion, v=>r.descripcion=v));

      const tdO = document.createElement("td");
      tdO.textContent = r.origen;
      tr.appendChild(tdO);

      const tdA = document.createElement("td");
      const bDel = document.createElement("button");
      bDel.className = "btn danger";
      bDel.style.padding = "8px 10px";
      bDel.textContent = "üóëÔ∏è";
      bDel.addEventListener("click", ()=>{ state.rows.splice(idx,1); renderTable(); });
      tdA.appendChild(bDel);
      tr.appendChild(tdA);

      tb.appendChild(tr);
    });
    $("countRows").textContent = `${state.rows.length} registros`;
  }

  function addRowFromPreview(p, origen){
    state.rows.unshift({
      razon_social: safeText(p.razon_social),
      fecha: safeText(p.fecha),
      cantidad: safeText(p.cantidad),
      descripcion: safeText(p.descripcion),
      origen
    });
    renderTable();
  }

  $("btnClearAll").addEventListener("click", ()=>{
    if(confirm("¬øLimpiar toda la tabla?")){ state.rows=[]; renderTable(); }
  });

  $("btnDownloadCsv").addEventListener("click", ()=>{
    const headers = ["RAZON_SOCIAL","FECHA","CANTIDAD","DESCRIPCION","ORIGEN"];
    const esc = (v)=> `"${String(v ?? "").replaceAll('"','""')}"`;
    const lines = [headers.join(",")];
    state.rows.forEach(r=>{
      lines.push([esc(r.razon_social), esc(r.fecha), esc(r.cantidad), esc(r.descripcion), esc(r.origen)].join(","));
    });
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `guias_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // QR
  function setQrButtons(has){
    $("btnOpenQr").disabled = !has;
    $("btnCopyQr").disabled = !has;
  }

  $("btnStartQr").addEventListener("click", async ()=>{
    const isSecure = (location.protocol==="https:" || location.hostname==="localhost" || location.hostname==="127.0.0.1");
    if(!isSecure){
      alert("Est√°s en origen no seguro (file://). Para usar c√°mara/QR, ejecuta en http://localhost o publica en HTTPS.");
      return;
    }
    try{
      if(state.qr.scanner){
        await state.qr.scanner.stop().catch(()=>{});
        state.qr.scanner.clear();
        state.qr.scanner = null;
      }
      state.qr.lastText = "";
      $("qrResult").textContent = "(Escaneando‚Ä¶)";
      setQrButtons(false);

      const scanner = new Html5Qrcode("qr-reader");
      state.qr.scanner = scanner;

      await scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 240, height: 240 } },
        async (decodedText)=>{
          state.qr.lastText = decodedText;
          $("qrResult").textContent = decodedText;
          setQrButtons(true);
          await scanner.stop().catch(()=>{});
        },
        ()=>{}
      );
    }catch(err){
      alert("No se pudo iniciar c√°mara/QR. Aseg√∫rate de estar en HTTPS o localhost y dar permisos.\n\nDetalle: " + err);
    }
  });

  $("btnStopQr").addEventListener("click", async ()=>{
    try{
      if(state.qr.scanner){
        await state.qr.scanner.stop().catch(()=>{});
        state.qr.scanner.clear();
        state.qr.scanner = null;
      }
      $("qrResult").textContent = state.qr.lastText ? state.qr.lastText : "(Detenido)";
    }catch(e){}
  });

  $("btnOpenQr").addEventListener("click", ()=>{
    const u = state.qr.lastText; if(!u) return;
    window.open(u, "_blank", "noopener,noreferrer");
  });

  $("btnCopyQr").addEventListener("click", async ()=>{
    const u = state.qr.lastText; if(!u) return;
    try{ await navigator.clipboard.writeText(u); alert("Link copiado."); }
    catch(e){ alert("Copia manualmente:\n\n" + u); }
  });

  // Extracci√≥n de campos (mejorada para cantidad al final)
  function extractFieldsFromText(rawText){
    const text = normalizeText(rawText);

    // Raz√≥n social (Destinatario preferido)
    let rs = "";
    let m = text.match(/Datos\s+del\s+Destinatario\s*:\s*([^\n\r\-]+?)(?:\s*-\s*REGISTRO|\s*-\s*RUC|\s*RUC|\n)/i);
    if(m && safeText(m[1])) rs = safeText(m[1]);

    // Fecha (inicio traslado preferido)
    let fecha = "";
    m = text.match(/Fecha\s+de\s+inicio\s+de\s+Traslado\s*:?\s*([\s\S]{0,40}?)(\d{2}[\/\-]\d{2}[\/\-]\d{2,4})/i);
    if(m && safeText(m[2])) fecha = fmtDateLike(m[2]);
    if(!fecha){
      m = text.match(/Fecha\s+y\s+hora\s+de\s+emisi[√≥o]n\s*:?\s*([\s\S]{0,30}?)(\d{2}[\/\-]\d{2}[\/\-]\d{2,4})/i);
      if(m && safeText(m[2])) fecha = fmtDateLike(m[2]);
    }

    // Cantidad + Descripci√≥n: buscar secci√≥n bienes
    const lines = text.split("\n").map(s=>s.trim()).filter(Boolean);
    let startIdx = 0;
    const idxBienes = lines.findIndex(l => /Bienes\s+por\s+transportar/i.test(l));
    if(idxBienes >= 0) startIdx = idxBienes;

    const itemLines = [];
    for(let i=startIdx; i<Math.min(lines.length, startIdx+60); i++){
      const l = lines[i];
      // √≠tem t√≠pico: "1 NO - ... UNIDAD (NIU) 30.00"
      if(/^\d+\s+/.test(l) && /NIU|UNIDAD|KGM|KG|UND/i.test(l) && /\d+(?:[.,]\d+)?\s*$/.test(l)){
        itemLines.push(l);
      }
    }

    let cantidad = "";
    let descripcion = "";

    if(itemLines.length){
      let sum = 0;
      const descs = [];

      itemLines.slice(0,10).forEach(l=>{
        // cantidad es el n√∫mero al FINAL
        const qMatch = l.match(/(\d+(?:[.,]\d+)?)\s*$/);
        const q = qMatch ? parseFloat(qMatch[1].replace(",", ".")) : NaN;
        if(!isNaN(q)) sum += q;

        // descripci√≥n: quitar √≠ndice y cantidad final y etiquetas "UNIDAD (NIU)" etc.
        let d = l
          .replace(/^\d+\s+/,"")                          // quita "1 "
          .replace(/\s+(\d+(?:[.,]\d+)?)\s*$/,"")         // quita " 30.00"
          .replace(/\bNO\s*-\s*/i,"")                     // quita "NO -"
          .replace(/\bUNIDAD\s*\(?.*?\)?/ig,"")           // quita "UNIDAD (NIU)" o similares
          .replace(/\bNIU\b/ig,"")
          .replace(/\bKGM\b/ig,"")
          .replace(/\bKG\b/ig,"")
          .replace(/\bUND\b/ig,"")
          .replace(/\s{2,}/g," ")
          .trim();

        if(d) descs.push(d);
      });

      cantidad = (sum ? String(sum) : "").replace(/\.0+$/,"");
      descripcion = descs.filter(Boolean).join(" | ");
      if(itemLines.length > 10) descripcion += ` | (+${itemLines.length-10} √≠tems)`;
    }

    // fallbacks
    if(!rs){
      m = text.match(/Raz[o√≥]n\s+Social\s*[:\-]?\s*([^\n\r]+)/i);
      if(m) rs = safeText(m[1]);
    }
    if(!fecha){
      m = text.match(/(\d{2}[\/\-]\d{2}[\/\-]\d{2,4})/);
      if(m) fecha = fmtDateLike(m[1]);
    }

    return { razon_social: rs, fecha, cantidad, descripcion, debug: text };
  }

  // PDF: reconstrucci√≥n de l√≠neas (para que no se pegue todo)
  async function extractTextFromPdf(file){
    const ab = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: ab}).promise;
    let out = "";

    for(let p=1; p<=pdf.numPages; p++){
      setOverlayPct((p-1)/pdf.numPages*100, `Leyendo PDF (p√°g ${p}/${pdf.numPages})‚Ä¶`);
      const page = await pdf.getPage(p);
      const tc = await page.getTextContent();

      // agrupar por l√≠nea usando coordenada Y
      const items = tc.items
        .map(it => ({ str: it.str, x: it.transform[4], y: it.transform[5] }))
        .filter(it => safeText(it.str));

      // ordenar por y (desc) y luego x (asc)
      items.sort((a,b)=> (b.y - a.y) || (a.x - b.x));

      const lines = [];
      const yTol = 2.0;
      let current = [];
      let lastY = null;

      for(const it of items){
        if(lastY === null || Math.abs(it.y - lastY) <= yTol){
          current.push(it);
          if(lastY === null) lastY = it.y;
        }else{
          // cerrar l√≠nea
          current.sort((a,b)=>a.x-b.x);
          lines.push(current.map(z=>z.str).join(" ").replace(/\s+/g," ").trim());
          current = [it];
          lastY = it.y;
        }
      }
      if(current.length){
        current.sort((a,b)=>a.x-b.x);
        lines.push(current.map(z=>z.str).join(" ").replace(/\s+/g," ").trim());
      }

      out += lines.join("\n") + "\n";
    }
    return normalizeText(out);
  }

  // OCR (simplificado)
  function drawImageToCanvas(img, rotationDeg){
    const canvas = $("imgCanvas");
    const ctx = canvas.getContext("2d");

    const w = img.naturalWidth || img.width;
    const h = img.naturalHeight || img.height;

    const rot = ((rotationDeg % 360) + 360) % 360;
    let cw = w, ch = h;
    if(rot === 90 || rot === 270){ cw = h; ch = w; }

    const maxSide = 1600;
    const scale = Math.min(1, maxSide / Math.max(cw, ch));

    canvas.width = Math.floor(cw * scale);
    canvas.height = Math.floor(ch * scale);

    ctx.save();
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#0a0f1c";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.rotate(rot * Math.PI/180);
    ctx.scale(scale, scale);
    ctx.drawImage(img, -w/2, -h/2, w, h);
    ctx.restore();

    state.fis.canvasReady = true;
  }

  async function fileToImage(file){
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.decoding = "async";
    img.src = url;
    await new Promise((res, rej)=>{ img.onload=()=>res(); img.onerror=(e)=>rej(e); });
    // liberamos URL luego (no afecta el img ya cargado)
    URL.revokeObjectURL(url);
    return img;
  }

  async function ocrCanvas(canvas){
    const result = await Tesseract.recognize(canvas, "spa+eng", {
      logger: (m)=>{
        if(m.status === "recognizing text"){
          setOverlayPct((m.progress||0)*100, "OCR: reconociendo texto‚Ä¶");
        } else if(m.status){
          $("ovMsg").textContent = "OCR: " + m.status;
        }
      }
    });
    return normalizeText(result.data.text || "");
  }

  async function ocrPdfScanned(file){
    const ab = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: ab}).promise;
    let out = "";
    for(let p=1; p<=pdf.numPages; p++){
      setOverlayPct((p-1)/pdf.numPages*100, `Renderizando PDF escaneado (p√°g ${p}/${pdf.numPages})‚Ä¶`);
      const page = await pdf.getPage(p);
      const viewport = page.getViewport({scale: 2});
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      await page.render({canvasContext: ctx, viewport}).promise;
      $("ovMsg").textContent = `OCR p√°gina ${p}/${pdf.numPages}‚Ä¶`;
      out += "\n" + (await ocrCanvas(canvas)) + "\n";
    }
    return normalizeText(out);
  }

  // Previews
  function setPreviewElec(p){
    state.previewElec = p;
    $("prevElecRS").value = p.razon_social || "";
    $("prevElecFecha").value = p.fecha || "";
    $("prevElecCant").value = p.cantidad || "";
    $("prevElecDesc").value = p.descripcion || "";
    $("debugElec").textContent = p.debug || "";
    $("prevElecMeta").textContent = `Extra√≠do ‚Üí RS="${p.razon_social||"-"}", Fecha="${p.fecha||"-"}", Cant="${p.cantidad||"-"}"`;
    $("btnAddPreviewElec").disabled = false;
    $("btnResetPreviewElec").disabled = false;
  }

  function setPreviewFis(p){
    state.previewFis = p;
    $("prevFisRS").value = p.razon_social || "";
    $("prevFisFecha").value = p.fecha || "";
    $("prevFisCant").value = p.cantidad || "";
    $("prevFisDesc").value = p.descripcion || "";
    $("debugFis").textContent = p.debug || "";
    $("prevFisMeta").textContent = `OCR ‚Üí RS="${p.razon_social||"-"}", Fecha="${p.fecha||"-"}", Cant="${p.cantidad||"-"}"`;
    $("btnAddPreviewFis").disabled = false;
    $("btnResetPreviewFis").disabled = false;
  }

  // Electr√≥nica: PDF upload
  $("filePdfElec").addEventListener("change", async (ev)=>{
    const f = ev.target.files?.[0];
    if(!f) return;

    setOverlay(true, "Leyendo PDF", "Preparando‚Ä¶", 0);
    try{
      const text = await extractTextFromPdf(f);
      setOverlayPct(90, "Extrayendo campos‚Ä¶");
      const p = extractFieldsFromText(text);
      setPreviewElec(p);
      setOverlayPct(100, "Listo");
    }catch(err){
      alert("No pude leer el PDF. Si es escaneado, usa la opci√≥n Gu√≠a f√≠sica (OCR).\n\nDetalle: " + err);
    }finally{
      setTimeout(()=>setOverlay(false), 250);
    }
  });

  $("btnAddPreviewElec").addEventListener("click", ()=>{
    addRowFromPreview({
      razon_social: $("prevElecRS").value,
      fecha: fmtDateLike($("prevElecFecha").value),
      cantidad: $("prevElecCant").value,
      descripcion: $("prevElecDesc").value
    }, "ELECTRONICA(PDF)");
  });

  $("btnResetPreviewElec").addEventListener("click", ()=>{
    if(state.previewElec) setPreviewElec(state.previewElec);
  });

  // F√≠sica: file upload
  $("fileFis").addEventListener("change", async (ev)=>{
    const f = ev.target.files?.[0];
    if(!f) return;
    state.fis.file = f;
    state.fis.rotation = 0;
    state.fis.canvasReady = false;

    $("btnRotateL").disabled = false;
    $("btnRotateR").disabled = false;
    $("btnRunOcr").disabled = false;

    $("btnAddPreviewFis").disabled = true;
    $("btnResetPreviewFis").disabled = true;
    $("debugFis").textContent = "";
    $("prevFisMeta").textContent = "";

    if(f.type === "application/pdf"){
      const ctx = $("imgCanvas").getContext("2d");
      ctx.clearRect(0,0,$("imgCanvas").width,$("imgCanvas").height);
      ctx.fillStyle = "#0a0f1c";
      ctx.fillRect(0,0,$("imgCanvas").width,$("imgCanvas").height);
      ctx.fillStyle = "rgba(232,238,252,.85)";
      ctx.font = "18px system-ui";
      ctx.fillText("PDF cargado (escaneado)", 20, 40);
      ctx.font = "14px system-ui";
      ctx.fillStyle = "rgba(168,179,214,.95)";
      ctx.fillText("Pulsa ‚ÄúOCR & Extraer‚Äù para procesar.", 20, 70);
      return;
    }

    try{
      const img = await fileToImage(f);
      drawImageToCanvas(img, state.fis.rotation);
    }catch(err){
      alert("No pude cargar la imagen.\n\nDetalle: " + err);
    }
  });

  $("btnRotateL").addEventListener("click", async ()=>{
    if(!state.fis.file || state.fis.file.type==="application/pdf") return;
    state.fis.rotation = (state.fis.rotation - 90) % 360;
    const img = await fileToImage(state.fis.file);
    drawImageToCanvas(img, state.fis.rotation);
  });

  $("btnRotateR").addEventListener("click", async ()=>{
    if(!state.fis.file || state.fis.file.type==="application/pdf") return;
    state.fis.rotation = (state.fis.rotation + 90) % 360;
    const img = await fileToImage(state.fis.file);
    drawImageToCanvas(img, state.fis.rotation);
  });

  $("btnRunOcr").addEventListener("click", async ()=>{
    const f = state.fis.file;
    if(!f) return;

    setOverlay(true, "OCR (Gu√≠a f√≠sica)", "Preparando‚Ä¶", 0);
    try{
      let text = "";
      if(f.type==="application/pdf"){
        text = await ocrPdfScanned(f);
      }else{
        if(!state.fis.canvasReady){
          const img = await fileToImage(f);
          drawImageToCanvas(img, state.fis.rotation);
        }
        text = await ocrCanvas($("imgCanvas"));
      }
      setOverlayPct(92, "Extrayendo campos‚Ä¶");
      setPreviewFis(extractFieldsFromText(text));
      setOverlayPct(100, "Listo");
    }catch(err){
      alert("OCR fall√≥ o no se pudo procesar.\n\nDetalle: " + err);
    }finally{
      setTimeout(()=>setOverlay(false), 250);
    }
  });

  $("btnAddPreviewFis").addEventListener("click", ()=>{
    addRowFromPreview({
      razon_social: $("prevFisRS").value,
      fecha: fmtDateLike($("prevFisFecha").value),
      cantidad: $("prevFisCant").value,
      descripcion: $("prevFisDesc").value
    }, "FISICA(OCR)");
  });

  $("btnResetPreviewFis").addEventListener("click", ()=>{
    if(state.previewFis) setPreviewFis(state.previewFis);
  });

  // init
  renderTable();
  setQrButtons(false);
</script>
</body>
</html>
